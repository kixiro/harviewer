/* See license.txt for terms of usage */

define("domplate/domTree",["domplate/domplate","core/lib","core/trace"],function(e,t,r){function n(e){this.input=e,this.view=$.isXMLDoc(e)?new o(e):new s(e)}function i(e){if("string"==typeof e)return!1;try{for(var t in e)return!0}catch(e){}return!1}function s(e){this.input=e}function o(e){this.input=e}function a(e){try{return e.toString()}catch(e){return""}}function l(e){var t=a(e),r=/\[object (.*?)\]/,n=r.exec(t);return n?n[1]:t}var u=e.domplate,m=e.DIV,c=e.FOR,p=e.SPAN,b=e.TABLE,h=e.TAG,g=e.TBODY,f=e.TD,d=e.TR;n.prototype=u({tag:b({class:"domTable",cellpadding:0,cellspacing:0,onclick:"$onClick"},g(c("member","$object|memberIterator",h("$member|getRowTag",{member:"$member"})))),rowTag:d({class:"memberRow $member.open $member.type\\Row $member|hasChildren",$hasChildren:"$member|hasChildren",_repObject:"$member",level:"$member.level"},f({class:"memberLabelCell",style:"padding-left: $member.indent\\px"},p({class:"memberLabel $member.type\\Label"},"$member.name")),f({class:"memberValueCell"},h("$member.tag",{object:"$member|getValue"}))),loop:c("member","$members",h("$member|getRowTag",{member:"$member"})),hasChildren:function(e){return e.hasChildren?"hasChildren":""},memberIterator:function(e){return this.view.getMembers(e)},getValue:function(e){return e.value},getRowTag:function(e){return this.rowTag},onClick:function(e){var r=t.fixEvent(e);if(t.isLeftClick(r)){var n=t.getAncestorByClass(r.target,"memberRow"),i=t.getAncestorByClass(r.target,"memberLabel");i&&t.hasClass(n,"hasChildren")&&this.toggleRow(n)}},toggleRow:function(e,r){if(e){var n=parseInt(e.getAttribute("level"),10);if(!r||!t.hasClass(e,"opened"))if(t.hasClass(e,"opened")){t.removeClass(e,"opened");for(var i=e.parentNode,s=e.nextSibling;s&&!(parseInt(s.getAttribute("level"),10)<=n);s=e.nextSibling)i.removeChild(s)}else{t.setClass(e,"opened");var o=e.repObject;if(o){if(!o.hasChildren)return;var a=this.view.getMembers(o.value,n+1);a&&this.loop.insertRows({members:a},e)}}}},append:function(e){this.element=this.tag.append({object:this.input},e,this),this.element.repObject=this;var r=t.isArray(this.input)&&this.input.length>2,n=this.element.firstChild.firstChild;n&&!r&&this.toggleRow(n)},expandRow:function(e){var t=this.getRow(e);return this.toggleRow(t,!0),t},getRow:function(e){if(this.element){for(var r=t.getElementsByClass(this.element,"memberRow"),n=0;n<r.length;n++){var i=r[n];if(i.repObject.value===e)return i}return null}}}),n.createMember=function(e,t,r,i,s){var o=n.Reps.getRep(r);return{name:t,value:r,type:e,rowClass:"memberRow-"+e,open:"",level:s,indent:16*s,hasChildren:i,tag:o.tag}};var v=m({class:"objectBox objectBox-$className"});s.prototype.getMembers=function(e,t){t||(t=0);var r=[];for(var i in e){var s=e[i];"function"!=typeof s&&r.push(n.createMember("dom",i,s,this.hasChildren(s),t))}return r},s.prototype.hasChildren=function(e){return i(e)&&"object"==typeof e},o.prototype.getMembers=function(e,t){t||(t=0);var r=o.nodeAttributes(e).map(function(e){return n.createMember("dom","@"+e.name,e.value,!1,t)}),i=o.nodeChildElements(e).map(function(e){var r=this.hasChildren(e);return n.createMember("dom",e.tagName,r?e:e.firstChild.nodeValue,r,t)},this),s=r;return 0===i.length&&e.firstChild&&s.push(n.createMember("dom","value",e.firstChild.nodeValue,!1,t)),s.concat(i)},o.prototype.hasChildren=function(e){return o.hasChildren(e)},o.hasChildren=function(e){var t=o.nodeAttributes(e),r=o.nodeChildElements(e);return t.length>0||r.length>0},o.nodeChildElements=function(e,t){t="number"===t?t:null;for(var r=[],n=e.firstChild;n;){if(Node.ELEMENT_NODE===n.nodeType&&(r.push(n),null!==t&&r.length>=t))return r;n=n.nextSibling}return r},o.nodeAttributes=function(e,t){t="number"===t?t:null;var r=[];if(!e.attributes)return r;for(var n=e.attributes.length;--n>=0;)if(r.push(e.attributes[n]),null!==t&&r.length>=t)return r;return r},n.Reps={reps:[],registerRep:function(){this.reps.push.apply(this.reps,arguments)},getRep:function(e){var t=typeof e;"object"===t&&e instanceof String&&(t="string");for(var i=0;i<this.reps.length;++i){var s=this.reps[i];try{if(s.supportsObject(e,t))return s}catch(e){r.exception("domTree.getRep; ",e)}}return n.Rep}},n.Rep=u({tag:v("$object|getTitle"),className:"object",getTitle:function(e){return l(e)},getTooltip:function(e){return null},supportsObject:function(e,t){return!1}}),n.Reps.Null=u(n.Rep,{tag:v("null"),className:"null",supportsObject:function(e,t){return null===e}}),n.Reps.Number=u(n.Rep,{tag:v("$object"),className:"number",supportsObject:function(e,t){return"boolean"===t||"number"===t}}),n.Reps.String=u(n.Rep,{tag:v("$object"),className:"string",supportsObject:function(e,t){return"string"===t}}),n.Reps.Arr=u(n.Rep,{tag:v("$object|getTitle"),className:"array",supportsObject:function(e,r){return t.isArray(e)},getTitle:function(e){return"Array ["+e.length+"]"}});var R=u(n.prototype,{createMember:function(e,t,r,i){var s=n.createMember(e,t,r,!1,i);return 0===i&&(s.name="",s.type="tableCell"),s}});return n.Reps.Tree=u(n.Rep,{tag:v(h("$object|getTag",{object:"$object|getRoot"})),className:"tree",getTag:function(e){return R.tag},getRoot:function(e){return[e]},supportsObject:function(e,t){return"object"===t}}),n.Reps.registerRep(n.Reps.Null,n.Reps.Number,n.Reps.String,n.Reps.Arr),n});