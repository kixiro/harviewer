/* See license.txt for terms of usage */

define("domplate/popupMenu",["domplate/domplate","core/lib","core/trace"],function(e,t,i){function n(e){if(!e.element){e.getItems&&(e.items=e.getItems()),"-"===e.items[0]&&e.items.shift(),"-"===e.items[e.items.length-1]&&e.items.pop();var i=t.getBody(document);e.element=d.tag.append({object:e},i,d)}t.append(this,e),"string"==typeof this.element?(this.id=this.element,this.element=$(this.id)):this.id&&(this.element.id=this.id),this.elementStyle=this.element.style,this.isVisible=!1,this.handleMouseDown=t.bind(this.handleMouseDown,this),this.handleMouseOver=t.bind(this.handleMouseOver,this),this.handleMouseOut=t.bind(this.handleMouseOut,this),this.handleWindowMouseDown=t.bind(this.handleWindowMouseDown,this)}var s=e.domplate,o=e.A,l=e.DIV,h=e.FOR,u=e.SPAN,a=e.TAG,r={controllers:[],controllerContext:{label:"controller context"},initialize:function(e){this.controllers=[],this.controllerContext=e||this.controllerContext},shutdown:function(){this.removeControllers()},addController:function(){for(var e,i=0;e=arguments[i];i++){var n=e[2];e[2]=t.bind(n,this),e[3]=n,this.controllers.push(e),t.addEventListener.apply(this,e)}},removeController:function(){for(var e,i=0;e=arguments[i];i++)for(var n,s=0;n=this.controllers[s];s++)e[0]===n[0]&&e[1]===n[1]&&e[2]===n[3]&&t.removeEventListener.apply(this,n)},removeControllers:function(){for(var e,i=0;e=this.controllers[i];i++)t.removeEventListener.apply(this,e)}},p={class:"$item.className",type:"$item.type",value:"$item.value",_command:"$item.command"};t.isIE6&&(p.href="javascript:void(0)");var d=s({tag:l({class:"popupMenu popupMenuShadow"},l({class:"popupMenuContent popupMenuShadowContent"},h("item","$object.items|memberIterator",a("$item.tag",{item:"$item"})))),itemTag:o(p,"$item.label"),checkBoxTag:o(t.extend(p,{checked:"$item.checked"}),"$item.label"),radioButtonTag:o(t.extend(p,{selected:"$item.selected"}),"$item.label"),groupTag:o(t.extend(p,{child:"$item.child"}),"$item.label"),shortcutTag:o(p,"$item.label",u({class:"popupMenuShortcutKey"},"$item.key")),separatorTag:u({class:"popupMenuSeparator"}),memberIterator:function(e){for(var i=[],n=0,s=e.length;n<s;n++){var o=e[n];if("string"!=typeof o||0!==o.indexOf("-")){o=t.extend(o,{}),o.type=o.type||"",o.value=o.value||"";var l=o.type;o.tag=this.itemTag;var h=o.className||"";h+="popupMenuOption ","checkbox"===l?(h+="popupMenuCheckBox ",o.tag=this.checkBoxTag):"radio"===l?(h+="popupMenuRadioButton ",o.tag=this.radioButtonTag):"group"===l?(h+="popupMenuGroup ",o.tag=this.groupTag):"shortcut"===l&&(h+="popupMenuShortcut ",o.tag=this.shortcutTag),o.checked?h+="popupMenuChecked ":o.selected&&(h+="popupMenuRadioSelected "),o.disabled&&(h+="popupMenuDisabled "),o.className=h,o.label=o.label,i.push(o)}else i.push({tag:this.separatorTag})}return i}}),c={};return n.prototype=t.extend(r,{initialize:function(){r.initialize.call(this),this.addController([this.element,"mousedown",this.handleMouseDown],[this.element,"mouseover",this.handleMouseOver])},destroy:function(){this.hide(),this.parentMenu&&(this.parentMenu.childMenu=null),this.element.parentNode.removeChild(this.element),this.element=null,this.elementStyle=null,this.parentMenu=null,this.parentTarget=null},shutdown:function(){r.shutdown.call(this)},showPopup:function(e){var i=t.isIE6?1:-4,n=t.getElementBox(e),s={top:0,left:0};this.show(n.left+i-s.left,n.top+n.height-5-s.top)},show:function(e,i){if(this.initialize(),!this.isVisible){if(e=e||0,i=i||0,this.parentMenu){var n=this.parentMenu.childMenu;n&&n!==this&&n.destroy(),this.parentMenu.childMenu=this}else t.addEventListener(document,"mousedown",this.handleWindowMouseDown);this.elementStyle.display="block",this.elementStyle.visibility="hidden";var s=t.getWindowSize();e=Math.min(e,s.width-this.element.clientWidth-10),e=Math.max(e,0),i=Math.min(i,s.height-this.element.clientHeight-10),i=Math.max(i,0),this.elementStyle.left=e+"px",this.elementStyle.top=i+"px",this.elementStyle.visibility="visible",this.isVisible=!0,t.isFunction(this.onShow)&&this.onShow.apply(this,arguments)}},hide:function(){this.clearHideTimeout(),this.clearShowChildTimeout(),this.isVisible&&(this.elementStyle.display="none",this.childMenu&&(this.childMenu.destroy(),this.childMenu=null),this.parentTarget&&t.removeClass(this.parentTarget,"popupMenuGroupSelected"),this.isVisible=!1,this.shutdown(),t.isFunction(this.onHide)&&this.onHide.apply(this,arguments))},showChildMenu:function(e){var i=e.getAttribute("child"),s=this;this.showChildTimeout=window.setTimeout(function(){var o=t.getElementBox(e),l=c.hasOwnProperty(i)?c[i]:{element:$(i)},h=new n(t.extend(l,{parentMenu:s,parentTarget:e})),u=t.isIE6?-1:-6;h.show(o.left+o.width+u,o.top-6),t.setClass(e,"popupMenuGroupSelected")},350)},clearHideTimeout:function(){this.hideTimeout&&(window.clearTimeout(this.hideTimeout),delete this.hideTimeout)},clearShowChildTimeout:function(){this.showChildTimeout&&(window.clearTimeout(this.showChildTimeout),this.showChildTimeout=null)},handleMouseDown:function(e){t.cancelEvent(e,!0);for(var i=this;i.parentMenu;)i=i.parentMenu;var n=e.target||e.srcElement;if(n=t.getAncestorByClass(n,"popupMenuOption"),!n||t.hasClass(n,"popupMenuGroup"))return!1;if(n&&!t.hasClass(n,"popupMenuDisabled")){var s=n.getAttribute("type");if("checkbox"===s){var o=n.getAttribute("value"),l=t.hasClass(n,"popupMenuChecked");l?(t.removeClass(n,"popupMenuChecked"),n.setAttribute("checked","")):(t.setClass(n,"popupMenuChecked"),n.setAttribute("checked","true")),t.isFunction(this.onCheck)&&this.onCheck.call(this,n,o,!l)}if("radiobutton"===s){for(var h=t.getElementsByClass(n.parentNode,"popupMenuRadioSelected"),u=n.getAttribute("group"),a=0,r=h.length;a<r;a++){var p=h[a];p.getAttribute("group")===u&&(t.removeClass(p,"popupMenuRadioSelected"),p.setAttribute("selected",""))}t.setClass(n,"popupMenuRadioSelected"),n.setAttribute("selected","true")}var d=null,c=n.command;t.isFunction(c)?d=c:"string"==typeof c&&(d=this[c]);var m=!0;d&&(m=d.call(this,n)!==!1),m&&i.hide()}return!1},handleWindowMouseDown:function(e){var i=e.target||e.srcElement;i=t.getAncestorByClass(i,"popupMenu"),i||(t.removeEventListener(document,"mousedown",this.handleWindowMouseDown),this.destroy())},handleMouseOver:function(e){this.clearHideTimeout(),this.clearShowChildTimeout();var i=e.target||e.srcElement;if(i=t.getAncestorByClass(i,"popupMenuOption")){var n=this.childMenu;n&&(t.removeClass(n.parentTarget,"popupMenuGroupSelected"),n.parentTarget!==i&&n.isVisible&&(n.clearHideTimeout(),n.hideTimeout=window.setTimeout(function(){n.destroy()},300))),t.hasClass(i,"popupMenuGroup")&&this.showChildMenu(i)}}}),t.append(n,{register:function(e){c[e.id]=e},check:function(e){t.setClass(e,"popupMenuChecked"),e.setAttribute("checked","true")},uncheck:function(e){t.removeClass(e,"popupMenuChecked"),e.setAttribute("checked","")},disable:function(e){t.setClass(e,"popupMenuDisabled")},enable:function(e){t.removeClass(e,"popupMenuDisabled")}}),n});