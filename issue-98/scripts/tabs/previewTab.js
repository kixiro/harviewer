/* See license.txt for terms of usage */

define("tabs/previewTab",["domplate/domplate","domplate/tabView","core/lib","i18n!nls/previewTab","domplate/toolbar","tabs/pageTimeline","tabs/harStats","preview/pageList","core/cookies","preview/validationError","downloadify/js/swfobject","downloadify/src/downloadify"],function(t,e,o,i,n,a,s,l,r,d){function h(t){this.model=t,this.toolbar=new n,this.timeline=new a,this.stats=new s(t,this.timeline),this.toolbar.addButtons(this.getToolbarButtons()),d.addListener(this)}var p=t.DIV;return h.prototype=o.extend(e.Tab.prototype,{id:"Preview",label:i.previewTabLabel,tabBodyTag:p({class:"tab$tab.id\\Body tabBody",_repObject:"$tab"},p({class:"previewToolbar"}),p({class:"previewTimeline"}),p({class:"previewStats"}),p({class:"previewList"})),onUpdateBody:function(t,e){this.toolbar.render(o.$(e,"previewToolbar")),this.stats.render(o.$(e,"previewStats")),this.timeline.render(o.$(e,"previewTimeline"));var i=this.model.input;i&&"true"===r.getCookie("timeline")&&this.onTimeline(!1),i&&"true"===r.getCookie("stats")&&this.onStats(!1),this.updateDownloadifyButton()},updateDownloadifyButton:function(){var t=this.model;$(".harDownloadButton").downloadify({filename:function(){return"netData.har"},data:function(){return t?t.toJSON():""},onComplete:function(){},onCancel:function(){},onError:function(){alert(i.downloadError)},swf:"scripts/downloadify/media/downloadify.swf",downloadImage:"css/images/download-sprites.png",width:16,height:16,transparent:!0,append:!1})},getToolbarButtons:function(){var t=[{id:"showTimeline",label:i.showTimelineButton,tooltiptext:i.showTimelineTooltip,command:o.bindFixed(this.onTimeline,this,!0)},{id:"showStats",label:i.showStatsButton,tooltiptext:i.showStatsTooltip,command:o.bindFixed(this.onStats,this,!0)},{id:"clear",label:i.clearButton,tooltiptext:i.clearTooltip,command:o.bindFixed(this.onClear,this)}];return t.push({id:"download",tooltiptext:i.downloadTooltip,className:"harDownloadButton"}),t},onTimeline:function(t){var e=this.toolbar.getButton("showTimeline");if(e){this.timeline.toggle(t);var o=this.timeline.isVisible();e.label=i[o?"hideTimelineButton":"showTimelineButton"],this.toolbar.render(),this.updateDownloadifyButton(),r.setCookie("timeline",o)}},onStats:function(t){var e=this.toolbar.getButton("showStats");if(e){this.stats.toggle(t);var o=this.stats.isVisible();e.label=i[o?"hideStatsButton":"showStatsButton"],this.toolbar.render(),this.updateDownloadifyButton(),r.setCookie("stats",o)}},onClear:function(){var t=document.location.href,e=t.indexOf("?");document.location=t.substr(0,e)},showStats:function(t){r.setCookie("stats",t)},showTimeline:function(t){r.setCookie("timeline",t)},append:function(t){var e=new l(t);e.append(o.$(this._body,"previewList")),this.timeline.append(t),e.addListener(this)},appendError:function(t){d.appendError(t,o.$(this._body,"previewList"))},addPageTiming:function(t){l.prototype.pageTimings.push(t)},getMenuItems:function(t,e,n){n&&(t.push("-"),t.push({label:i.menuShowHARSource,command:o.bind(this.showHARSource,this,e,n)}))},showHARSource:function(t,e,o){var i=this.tabView.getTab("DOM");i&&(i.select("DOM"),i.highlightFile(t,e))}}),h});