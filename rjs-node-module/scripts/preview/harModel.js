/* See license.txt for terms of usage */

define(["core/lib","preview/jsonSchema","preview/ref","preview/harSchema","core/cookies","core/trace","i18n!nls/harModel"],function(e,t,r,n,i,a,o){function s(){this.input=null}function u(){var e={};for(var t in this)"toJSON"!==t&&(e[t]=this[t]);return this.text?(e.text=Array.prototype.map.call(this.text,function(e){var t=e.charCodeAt(0);if(t>=32&&t<127||10===t||13===t)return e.charAt(0);for(var r=t.toString(16).toUpperCase();r.length<4;)r="0"+r;return"\\u"+r}).join(""),e):e}return s.prototype={append:function(t){if(!t)return void a.error("HarModel.append; Trying to append null input!");if(t.log.entries.sort(function(t,r){var n=e.parseISO8601(t.startedDateTime),i=e.parseISO8601(r.startedDateTime);return n<i?-1:n>i?1:0}),this.input){if(!t.log.pages)return a.error("Import of additional data without a page is not yet supported."),null;for(var r=0;r<t.log.pages.length;r++)this.importPage(t.log.pages[r],t.log.entries)}else this.input=e.cloneJSON(t);return this.input},getPages:function(){return this.input&&this.input.log.pages?this.input.log.pages:[]},getFirstPage:function(){var e=this.getPages();return e.length>0?e[0]:null},getPageEntries:function(e){return s.getPageEntries(this.input,e)},getAllEntries:function(e){return this.input?this.input.log.entries:[]},getParentPage:function(e){return s.getParentPage(this.input,e)},importPage:function(e,t){var r=this.getUniquePageID(e.id),n=e.id;e.id=r,this.input.log.pages.push(e);for(var i=0;i<t.length;i++){var a=t[i];a.pageref===n&&(a.pageref=r,this.input.log.entries.push(a))}},getUniquePageID:function(e){for(var t=this.input.log.pages,r={},n=0;n<t.length;n++)r[t[n].id]=!0;if(!r[e])return e;for(var i=1;;){var a=e+i;if(!r[a])return a;i++}},toJSON:function(e){if(e||(e=this.input),!e)return"";for(var t=this.input.log.entries,r=0;r<t.length;r++){var n=t[r];n.response.content.text&&(n.response.content.toJSON=u)}var i=JSON.stringify(this.input,null,"\t"),a=i.replace(/\\\\u/g,"\\u");return a}},s.parse=function(e,i){var o=e;try{"string"==typeof e&&(o=jQuery.parseJSON(e))}catch(e){throw a.exception("HarModel.parse; EXCEPTION",e),{errors:[{message:"Failed to parse JSON",property:"JSON evaluation"}]}}if(!i)return o;var s=r.resolveJson(n),u=t.validate(o,s.logType);if(u.valid)return this.validateRequestTimings(o),o;throw u},s.getPageEntries=function(e,t){var r=[],n=e.log.entries;if(!n)return r;for(var i=0;i<n.length;i++){var a=n[i];a.pageref||t||r.push(a),t&&a.pageref===t.id&&r.push(a)}return r},s.getParentPage=function(e,t){var r=e.log.pages;if(!r)return null;for(var n=0;n<r.length;n++)if(r[n].id===t.pageref)return r[n];return null},s.validateRequestTimings=function(t){for(var r=[],n=t.log.entries,i=0;i<n.length;i++){var a=n[i],s=a.timings;if(s.blocked<-1||s.connect<-1||s.dns<-1||s.receive<-1||s.send<-1||s.wait<-1){var u=e.formatString(o.validationNegativeTimeError,a.request.url,i,a.pageref);r.push({input:t,file:a,message:u,property:o.validationType})}}if(r.length)throw{errors:r,input:t}},s.isCachedEntry=function(e){var t=e.response,r=Math.max(0,t.bodySize);return 304===t.status||0===r&&t.content&&t.content.size>0},s.getEntrySize=function(e){var t=e.response.bodySize;return t&&t!==-1?t:e.response.content.size},s.getEntryUncompressedSize=function(e){return Math.max(0,e.response.content.size)||Math.max(0,e.response.bodySize)},s.getEntryTransferredSize=function(e){return 304===e.response.status?0:Math.max(0,e.response.bodySize)},s});