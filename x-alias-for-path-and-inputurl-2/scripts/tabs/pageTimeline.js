/* See license.txt for terms of usage */

define("tabs/pageTimeline",["domplate/domplate","core/lib","core/trace","i18n!nls/pageTimeline","preview/harModel"],function(e,t,i,s,n){function a(){this.listeners=[],this.element=null,this.maxElapsedTime=-1,this.lastSelectedBar=null}var l=e.domplate,o=e.DIV,g=e.FOR,r=e.PRE,c=e.SPAN,h=e.TABLE,p=e.TAG,m=e.TBODY,u=e.TD,d=e.TR,f={isSelected:function(e){return t.hasClass(e,"selected")},toggle:function(e){t.toggleClass(e,"selected")},select:function(e){this.isSelected(e)||t.setClass(e,"selected")},unselect:function(e){this.isSelected(e)&&t.removeClass(e,"selected")},getSelection:function(e){for(var i=[],s=t.getElementsByClass(e,"pageBar"),n=0;n<s.length;n++){var a=s[n];this.isSelected(a)&&i.push(a.page)}return i},unselectAll:function(e,i){for(var s=t.getElementsByClass(e,"pageBar"),n=0;n<s.length;n++)i!==s[n]&&this.unselect(s[n])}};return a.prototype=l({graphCols:g("page","$input|getPages",u({"class":"pageTimelineCol"},o({"class":"pageBar",_input:"$input",_page:"$page",title:s.pageBarTooltip,style:"height: $page|getHeight\\px",onmousemove:"$onMouseMove",onclick:"$onClick"}))),pageGraph:h({"class":"pageTimelineTable",cellpadding:0,cellspacing:0},m(d({"class":"pageTimelineRow"},p("$graphCols",{input:"$input"})))),tag:o({"class":"pageTimelineBody",style:"height: auto; display: none"},h({style:"margin: 7px;",cellpadding:0,cellspacing:0},m(d(u(p("$pageGraph",{input:"$input"}))),d(u({"class":"pageDescContainer",colspan:2}))))),getHeight:function(e){var t=1,i=e.pageTimings.onLoad;return i>0&&this.maxElapsedTime>0&&(t=Math.round(i/this.maxElapsedTime*100)),Math.max(1,t)},onClick:function(e){var i=t.fixEvent(e),s=i.target;if(t.hasClass(s,"pageBar")){var n=t.isControlClick(i),a=t.isShiftClick(i),l=t.getAncestorByClass(s,"pageTimelineRow");n||a||f.unselectAll(l,s),f.toggle(s),this.selectionChanged()}},onMouseMove:function(e){var i=t.fixEvent(e),s=i.target;if(t.hasClass(s,"pageBar")&&this.highlightedPage!==s.page){this.highlightedPage=s.page;var n=t.getElementByClass(this.element,"pageDescContainer");a.Desc.render(n,s)}},getPages:function(e){return e.log.pages?e.log.pages:[]},getPageBar:function(e){if(this.element)for(var i=t.getElementByClass(this.element,"pageTimelineTable"),s=i.firstChild.firstChild.firstChild;s;){if(s.firstChild.page===e)return s.firstChild;s=s.nextSibling}},recalcLayout:function(){this.maxElapsedTime=0;for(var e=this.maxElapsedTime,i=t.getElementsByClass(this.element,"pageBar"),s=0;s<i.length;s++){var n=i[s].page,a=n.pageTimings.onLoad;a>0&&this.maxElapsedTime<a&&(this.maxElapsedTime=a)}if(e!==this.maxElapsedTime)for(var l=0;l<i.length;l++)i[l].style.height=this.getHeight(i[l].page)+"px"},updateDesc:function(){if(this.isVisible()&&!this.highlightedPage){var e=t.getElementByClass(this.element,"pageBar");e&&t.fireEvent(e,"mousemove")}},addListener:function(e){this.listeners.push(e)},removeListener:function(e){t.remove(this.listeners,e)},selectionChanged:function(){var e=this.getSelection();t.dispatch(this.listeners,"onSelectionChange",[e])},removeSelection:function(){if(this.element){var e=t.getElementByClass(this.element,"pageTimelineRow");f.unselectAll(e),this.selectionChanged()}},getSelection:function(){if(!this.isVisible())return[];var e=t.getElementByClass(this.element,"pageTimelineRow");return f.getSelection(e)},show:function(e){this.isVisible()||(e?$(this.element).slideDown():this.element.style.display="block",t.setClass(this.element,"opened"),this.updateDesc())},hide:function(e){this.isVisible()&&(e?$(this.element).slideUp():this.element.style.display="none",t.removeClass(this.element,"opened"),this.removeSelection())},isVisible:function(){return t.hasClass(this.element,"opened")},toggle:function(e){this.isVisible()?this.hide(e):this.show(e)},render:function(e){return this.element=this.tag.replace({input:{log:{pages:[]}}},e,this),this.recalcLayout(),this.element},append:function(e,i){if(this.element){var s=t.getElementByClass(this.element,"pageTimelineRow");this.graphCols.insertCols({input:e},s,this),this.recalcLayout(),this.updateDesc()}}}),a.Desc=l({tag:o({"class":"pageDescBox"},o({"class":"connector"}),o({"class":"desc"},c({"class":"summary"},"$object|getSummary"),c({"class":"time"},"$object.page|getTime"),c({"class":"title"},"$object.page|getTitle"),r({"class":"comment"},"$object.page|getComment"))),getSummary:function(e){var i="",a=e.page.pageTimings.onLoad;a>0&&(i+=s.pageLoad+": "+t.formatTime(a.toFixed(2))+", ");var l=n.getPageEntries(e.input,e.page),o=l.length;return i+=o+" "+(1===o?s.request:s.requests)},getTime:function(e){var i=t.parseISO8601(e.startedDateTime),s=new Date(i);return s.toLocaleString()},getTitle:function(e){return e.title},getComment:function(e){return e.comment?e.comment:""},render:function(e,i){var s={input:i.input,page:i.page},n=this.tag.replace({object:s},e),a=t.$(n,"connector");return a.style.marginLeft=i.parentNode.offsetLeft+"px",n}}),a});