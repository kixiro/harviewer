/* See license.txt for terms of usage */

define("preview/pageList",["domplate/domplate","core/lib","core/trace","core/cookies","preview/requestList","i18n!nls/pageList","domplate/popupMenu"],function(e,t,n,s,i,o,a){function l(e){this.input=e,this.listeners=[]}var g=e.domplate,r=e.DIV,p=e.FOR,u=e.SPAN,c=e.TABLE,h=e.TAG,d=e.TBODY,f=e.TD,m=e.TR;return l.prototype=g({tableTag:c({"class":"pageTable",cellpadding:0,cellspacing:0,onclick:"$onClick",_repObject:"$input"},d(h("$rowTag",{groups:"$input.log.pages"}))),rowTag:p("group","$groups",m({"class":"pageRow",_repObject:"$group"},f({"class":"groupName pageCol",width:"1%"},u({"class":"pageName"},"$group|getPageTitle")),f({"class":"netOptionsCol netCol",width:"15px"},r({"class":"netOptionsLabel netLabel",onclick:"$onOpenOptions"})))),bodyTag:m({"class":"pageInfoRow",style:"height:auto;"},f({"class":"pageInfoCol",colspan:2})),getPageTitle:function(e){return t.cropString(e.title,100)},getPageID:function(e){return"["+e.id+"]"},onClick:function(e){var n=t.fixEvent(e);if(t.isLeftClick(e)){var s=t.getAncestorByClass(n.target,"pageRow");s&&(this.toggleRow(s),t.cancelEvent(e))}},toggleRow:function(e,n){var s=t.hasClass(e,"opened");if(!s||!n){var i;if(t.toggleClass(e,"opened"),t.hasClass(e,"opened")){i=this.bodyTag.insertRows({},e)[0];for(var o=this.createRequestList(),a=l.prototype.pageTimings,g=0;g<a.length;g++)o.addPageTiming(a[g]);o.render(i.firstChild,e.repObject)}else i=e.nextSibling,e.parentNode.removeChild(i)}},expandAll:function(e){for(var n=e.firstChild.firstChild;n;)t.hasClass(n,"pageRow")&&this.toggleRow(n,!0),n=n.nextSibling},getPageRow:function(e){for(var n=this.element.parentNode,s=t.getElementsByClass(n,"pageRow"),i=0;i<s.length;i++){var o=s[i];if(o.repObject===e)return o}},togglePage:function(e){var t=this.getPageRow(e);this.toggleRow(t)},expandPage:function(e){var t=this.getPageRow(e);this.toggleRow(t,!0)},collapsePage:function(e){var n=this.getPageRow(e);t.hasClass(n,"opened")&&this.toggleRow(n)},onOpenOptions:function(e){var n=t.fixEvent(e);if(t.cancelEvent(e),t.isLeftClick(e)){var s=n.target,i=t.getAncestorByClass(s,"pageRow"),o=this.getMenuItems(i.repObject),l=new a({id:"requestContextMenu",items:o});l.showPopup(s)}},getMenuItems:function(e){for(var n,s=i.getVisibleColumns().join(),a=0,l=[],g=0;g<i.columns.length;g++){var r=i.columns[g],p=s.indexOf(r)>-1;l.push({label:o["column.label."+r],type:"checkbox",checked:p,command:t.bindFixed(this.onToggleColumn,this,r)}),p&&(n=g,a++)}return 1===a&&(l[n].disabled=!0),l.push("-"),l.push({label:o["action.label.Reset"],command:t.bindFixed(this.updateColumns,this)}),l},onToggleColumn:function(e){var n=i.getVisibleColumns();t.remove(n,e)||n.push(e),this.updateColumns(n)},updateColumns:function(e){e||(e=i.defaultColumns),i.setVisibleColumns(e)},createRequestList:function(){var e=new i(this.input);return e.listeners=this.listeners,e},append:function(e){var n=this.createRequestList();n.render(e,null);var s=this.input.log.pages;if(s&&s.length){var i=this.tableTag.append({input:this.input},e,this),o=t.getElementsByClass(i,"pageRow"),a=t.getElementsByClass(e,"pageTable");1===o.length&&1===a.length&&this.toggleRow(o[0]);var l=t.getURLParameter("expand");l&&this.expandAll(i)}},render:function(e){this.append(e)},addListener:function(e){this.listeners.push(e)},removeListener:function(e){t.remove(this.listeners,e)}}),l.prototype.pageTimings=[],l});