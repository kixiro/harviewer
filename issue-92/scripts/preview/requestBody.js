/* See license.txt for terms of usage */

define("preview/requestBody",["domplate/domplate","i18n!nls/requestBody","core/lib","core/cookies","domplate/tabView","domplate/domTree","core/dragdrop","syntax-highlighter/shCore"],function(e,t,n,o,a,i,s,r){function l(){}function c(e){this.file=e}function p(e){this.file=e}function d(e){this.file=e}function f(e){this.file=e}function h(e){this.file=e}function u(e){this.file=e}function m(e){var n=e.request.method;n=n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),this.file=e,this.id=n,this.label=t[n]}function g(e){this.file=e}function T(e){this.file=e}function y(e){this.file=e}function x(e){this.file=e}function v(e){this.file=e}function I(e){this.file=e}var b=e.domplate,w=e.DIV,C=e.FOR,H=e.IFRAME,R=e.PRE,B=e.TABLE,q=e.TBODY,S=e.TD,D=e.TR;return l.tabTypes=[c,u,m,f,h,v,I,p,d,T,y,x],l.prototype=b({render:function(e,t){var n=new a("requestBody");l.tabTypes.forEach(function(e){e.canShowFile(t)&&n.appendTab(new e(t))});var o=n.render(e);return n.tabs.length>0&&n.selectTabByName(n.tabs[0].id),o}}),l.canShowFile=function(e){return l.tabTypes.some(function(t){return t.canShowFile(e)})},l.canDecode=function(e){return!e||"base64"===e&&"undefined"!=typeof atob},l.decode=function(e,t){function n(e){return decodeURIComponent(Array.prototype.map.call(atob(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}return"base64"!==t?e:n(e)},c.prototype=b(a.Tab.prototype,{id:"Headers",label:t.Headers,bodyTag:B({class:"netInfoHeadersText netInfoText netInfoHeadersTable",cellpadding:0,cellspacing:0},q(D({class:"netInfoResponseHeadersTitle"},S({colspan:2},w({class:"netInfoHeadersGroup"},t.ResponseHeaders))),D({class:"netInfoRequestHeadersTitle"},S({colspan:2},w({class:"netInfoHeadersGroup"},t.RequestHeaders))))),headerDataTag:C("param","$headers",D(S({class:"netInfoParamName"},"$param.name"),S({class:"netInfoParamValue"},R("$param|getParamValue")))),getParamValue:function(e){return n.wrapText(e.value,!0)},onUpdateBody:function(e,t){this.file.response.headers&&this.insertHeaderRows(t,this.file.response.headers,"Headers","ResponseHeaders"),this.file.request.headers&&this.insertHeaderRows(t,this.file.request.headers,"Headers","RequestHeaders")},insertHeaderRows:function(e,t,o,a){var i=n.getElementByClass(e,"netInfo"+o+"Table"),s=n.getElementByClass(i,"netInfo"+a+"Title");t.length?(this.headerDataTag.insertRows({headers:t},s?s:e),n.removeClass(s,"collapsed")):n.setClass(s,"collapsed")}}),c.canShowFile=function(e){return e.response.headers.length>0},p.prototype=b(a.Tab.prototype,{id:"Image",label:t.Image,title:t.ImageTitle,bodyTag:w({class:"netInfoImageText netInfoText"}),onUpdateBody:function(e,t){function o(e){var t=n.extractMimeType(e.mimeType);return"data:"+t+";base64,"+e.text}function a(e,n){var a=t.ownerDocument.createElement("img"),i=e.response.content;a.src=o(i),n.appendChild(a)}function i(e,t){var n=e.response.content,a=/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/;if(n.text.match(a)){var i=o(n);t.innerHTML="<img src="+i+">"}}var s=n.getElementByClass(t,"netInfoImageText");n.clearNode(s);var r=9===document.documentMode||10===document.documentMode;r?i(this.file,s):a(this.file,s)}}),p.isFileImage=function(e){var t=e.response.content;if(!t)return!1;var o=n.extractMimeType(t.mimeType||"");return n.startsWith(o,"image/")},p.canShowFile=function(e){var t=e.response.content;return p.isFileImage(e)&&t.text&&"base64"===t.encoding},d.prototype=b(a.Tab.prototype,{id:"ExternalImage",label:t.ExternalImage,title:t.ExternalImageTitle,bodyTag:w({class:"netInfoExternalImageText netInfoText"}),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoExternalImageText");n.clearNode(o);var a=t.ownerDocument.createElement("img");a.src=this.file.request.url,o.appendChild(a)}}),d.canShowFile=function(e){return p.isFileImage(e)},f.prototype=b(a.Tab.prototype,{id:"Response",label:t.Response,bodyTag:w({class:"netInfoResponseText netInfoText"},R()),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoResponseText"),a=o.firstChild;n.clearNode(a);var i=this.file.response.content,s=i.text;s=l.decode(s,i.encoding),n.insertWrappedText(s,a)}}),f.canShowFile=function(e){return e.response.content.text&&e.response.content.text.length>0},h.prototype=b(a.Tab.prototype,{id:"Highlighted",label:t.Highlighted,bodyTag:w({class:"netInfoHighlightedText netInfoText"},R({class:"toolbar: false; brush: ",name:"code"})),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoHighlightedText"),a=o.firstChild;n.clearNode(a);var i=this.file.response.content,s=i.text,c=n.extractMimeType(i.mimeType),p=h.shouldHighlightAs(c);p?(a.className+=p,s=l.decode(s,i.encoding),a.appendChild(document.createTextNode(s)),r.SyntaxHighlighter.highlight(a)):n.insertWrappedText(s,a)}}),h.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!l.canDecode(t.encoding))return!1;var o=n.extractMimeType(t.mimeType||"");return null!==h.shouldHighlightAs(o)},h.shouldHighlightAs=function(e){var t={javascript:["application/javascript","text/javascript","application/x-javascript","text/ecmascript","application/ecmascript","application/json"],css:["text/css"],html:["text/html","application/xhtml+xml"]};for(var n in t)if(t[n].indexOf(e)>-1)return n;return I.isXmlMimeType(e)?"xml":null},u.prototype=b(c.prototype,{id:"Params",label:t.URLParameters,bodyTag:B({class:"netInfoParamsText netInfoText netInfoParamsTable",cellpadding:0,cellspacing:0},q()),onUpdateBody:function(e,t){if(this.file.request.queryString){var o=n.getElementByClass(t,"netInfoParamsText");this.insertHeaderRows(o,this.file.request.queryString,"Params")}}}),u.canShowFile=function(e){return e.request.queryString&&e.request.queryString.length},m.prototype=b(c.prototype,{bodyTag:w({class:"netInfo$tab.id\\Text netInfoText"},B({class:"netInfo$tab.id\\Table",cellpadding:0,cellspacing:0},q())),onUpdateBody:function(e,t){var o=this.file.request.postData;if(o){var a=n.getElementByClass(t,"netInfo"+this.id+"Text");"application/x-www-form-urlencoded"===o.mimeType?this.insertHeaderRows(a,o.params,this.id):n.insertWrappedText(o.text,a)}}}),m.canShowFile=function(e){var t=e.request.postData;if(!t)return!1;var o=!n.isArray(t.params)||0===t.params.length,a=!t.text,i=o&&a;return!i||["PUT","POST"].indexOf(e.request.method)>-1},g.prototype=b(c.prototype,{id:"Cookies",label:t.Cookies,bodyTag:w({class:"netInfoCookiesText netInfoText"},B({class:"netInfoCookiesTable",cellpadding:0,cellspacing:0},q(D({class:"netInfoResponseCookiesTitle"},S({colspan:2},w({class:"netInfoCookiesGroup"},t.ResponseCookies))),D({class:"netInfoRequestCookiesTitle"},S({colspan:2},w({class:"netInfoCookiesGroup"},t.RequestCookies)))))),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoParamsText");this.file.response.cookies&&this.insertHeaderRows(o,this.file.response.cookies,"Cookies","ResponseCookies"),this.file.request.cookies&&this.insertHeaderRows(o,this.file.request.cookies,"Cookies","RequestCookies")}}),T.prototype=b(c.prototype,{id:"Cache",label:t.Cache,bodyTag:w({class:"netInfoCacheText netInfoText"},B({class:"netInfoCacheTable",cellpadding:0,cellspacing:0},q())),onUpdateBody:function(e,t){if(this.file.cache&&this.file.cache.afterRequest){var n=this.file.cache.afterRequest,o=[];for(var a in n)o.push({name:a,value:n[a]});this.insertHeaderRows(t,o,"Cache")}}}),T.canShowFile=function(e){return!!e.cache&&!!e.cache.afterRequest},y.prototype=b(c.prototype,{id:"HTML",label:t.HTML,bodyTag:w({class:"netInfoHtmlText netInfoText"},H({class:"netInfoHtmlPreview",onload:"$onLoad"}),w({class:"htmlPreviewResizer"})),onUpdateBody:function(e,t){this.preview=n.getElementByClass(t,"netInfoHtmlPreview");var a=parseInt(o.getCookie("htmlPreviewHeight"),10);isNaN(a)||(this.preview.style.height=a+"px");var i=n.getElementByClass(t,"htmlPreviewResizer");this.resizer=new s.Tracker(i,{onDragStart:n.bind(this.onDragStart,this),onDragOver:n.bind(this.onDragOver,this),onDrop:n.bind(this.onDrop,this)})},onLoad:function(e){var t=n.fixEvent(e),o=n.getAncestorByClass(t.target,"tabHTMLBody").repObject;o.preview.contentWindow.document.body.innerHTML=o.file.response.content.text},onDragStart:function(e){var t=n.getBody(this.preview.ownerDocument);t.setAttribute("hResizing","true"),this.startHeight=this.preview.clientHeight},onDragOver:function(e,t){var n=this.startHeight+e.y;this.preview.style.height=n+"px",o.setCookie("htmlPreviewHeight",n)},onDrop:function(e){var t=n.getBody(this.preview.ownerDocument);t.removeAttribute("hResizing")}}),y.canShowFile=function(e){var t=e.response.content.mimeType||"",o=e.mimeType||"";return n.startsWith(t,"text/html")||n.startsWith(o,"application/xhtml+xml")},x.prototype=b(c.prototype,{id:"DataURL",label:t.DataURL,bodyTag:w({class:"netInfoDataURLText netInfoText"}),onUpdateBody:function(e,t){var o=n.getElementByClass(t,"netInfoDataURLText"),a=this.file.request.url;if(0===a.indexOf("data:image")){var i=t.ownerDocument.createElement("img");i.src=a,o.appendChild(i)}else n.insertWrappedText(unescape(a),o)}}),x.canShowFile=function(e){return 0===e.request.url.indexOf("data:")},v.prototype=b(a.Tab.prototype,{id:"JSON",label:t.JSON,bodyTag:w({class:"netInfoJsonText netInfoText"}),onUpdateBody:function(e,t){n.clearNode(t.firstChild);var o=this.file.response.content;try{var a=l.decode(o.text,o.encoding),s=JSON.parse(a),r=new i(s);r.append(t)}catch(e){t.innerHTML=String(e)}}}),v.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!l.canDecode(t.encoding))return!1;var o=n.extractMimeType(t.mimeType||"");return["application/json"].indexOf(o)>-1},I.prototype=b(a.Tab.prototype,{id:"XML",label:t.XML,bodyTag:w({class:"netInfoXmlText netInfoText"}),onUpdateBody:function(e,t){n.clearNode(t.firstChild);var o=this.file.response.content;try{var a=l.decode(o.text,o.encoding),s=$.parseXML(a),r=new i(s);r.append(t)}catch(e){t.innerHTML=String(e)}}}),I.isXmlMimeType=function(e){return e=n.extractMimeType(e),["text/xml","application/xml","image/svg+xml","application/atom+xml","application/xslt+xml","application/mathml+xml","application/rss+xml"].indexOf(e)>-1},I.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!l.canDecode(t.encoding))return!1;var o=n.extractMimeType(t.mimeType||"");return I.isXmlMimeType(o)},l});