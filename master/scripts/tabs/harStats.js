/* See license.txt for terms of usage */

define("tabs/harStats",["domplate/domplate","core/lib","core/StatsService","i18n!nls/harStats","preview/harModel","domplate/infoTip"],function(e,t,a,i,l,o){function n(){}function r(e,t,a,i){var l=[].slice.call(arguments,1);return l.reduce(function(t,a){var i=$("<div>").css("display","none").addClass(e).addClass(a);return i.appendTo(document.body),t[a]=i.css("color"),i.remove(),t},{})}function s(){}function c(){}function d(){}function u(){}function h(e,t){this.model=e,this.timeline=t,this.timeline.addListener(this)}var p=e.domplate,v=e.DIV,b=e.FOR,f=e.SPAN,m=e.TABLE,g=e.TBODY,S=e.TD,P=e.TR,T=p({tag:v({class:"pieLabelInfoTip"},"$text"),render:function(e,t){this.tag.replace({text:e},t)}}),y=p({tag:m({class:"pagePieTable",cellpadding:0,cellspacing:0,_repObject:"$pie"},g(P(S({class:"pieBox"}),S(b("item","$pie.data",v({class:"pieLabel",_repObject:"$item"},f({class:"box",style:"background-color: $item.color"},"&nbsp;"),f({class:"label"},"$item.label"))))))),render:function(e,a){var i=this.tag.append({pie:e},a),l=t.$(i,"pieBox"),o=document.createElement("canvas");return o.setAttribute("class","pieGraph"),o.setAttribute("height","100"),o.setAttribute("width","100"),l.appendChild(o),i},draw:function(e,t){if(e&&e.getContext){var a=e.getContext("2d"),i=Math.min(e.width,e.height)/2,l=[e.width/2,e.height/2];a.clearRect(0,0,e.width,e.height);var o,n=0,r=t.data,s=0;for(o=0;o<r.length;o++)s+=r[o].value;if(!s)return a.beginPath(),a.moveTo(l[0],l[1]),a.arc(l[0],l[1],i,0,2*Math.PI,!1),a.closePath(),a.fillStyle="rgb(229,236,238)",a.lineStyle="lightgray",void a.fill();for(o=0;o<r.length;o++){var c=r[o].value/s;c<=0||(a.beginPath(),a.moveTo(l[0],l[1]),a.arc(l[0],l[1],i,Math.PI*(-.5+2*n),Math.PI*(-.5+2*(n+c)),!1),a.lineTo(l[0],l[1]),a.closePath(),a.fillStyle=r[o].color,a.fill(),n+=c)}}},showInfoTip:function(e,a,i,l){var o=t.getAncestorByClass(a,"pagePieTable");if(!o)return!1;var n=t.getAncestorByClass(a,"pieLabel");if(n){var r=o.repObject.getLabelTooltipText(n.repObject);return T.render(r,e),!0}return"CANVAS"===a.tagName?(T.render(o.repObject.title,e),!0):void 0}});n.prototype={data:[],title:"",getLabelTooltipText:function(e){return e.label+": "+t.formatSize(e.value)},cleanUp:function(){for(var e=0;e<this.data.length;e++)this.data[e].value=0,this.data[e].count=0}};var L={TimingPie:r("TimingPie","Blocked","DNS","SSL","Connect","Send","Wait","Receive"),ContentPie:r("ContentPie","HTMLText","JavaScript","CSS","Image","Flash","Others"),TrafficPie:r("TrafficPie","HeadersSent","BodiesSent","HeadersReceived","BodiesReceived"),CachePie:r("CachePie","Downloaded","Partial","FromCache")};s.prototype=t.extend(n.prototype,{title:"Summary of request times.",data:[{value:0,label:i.pieLabelBlocked,color:L.TimingPie.Blocked},{value:0,label:i.pieLabelDNS,color:L.TimingPie.DNS},{value:0,label:i.pieLabelSSL,color:L.TimingPie.SSL},{value:0,label:i.pieLabelConnect,color:L.TimingPie.Connect},{value:0,label:i.pieLabelSend,color:L.TimingPie.Send},{value:0,label:i.pieLabelWait,color:L.TimingPie.Wait},{value:0,label:i.pieLabelReceive,color:L.TimingPie.Receive}],getLabelTooltipText:function(e){return e.label+": "+t.formatTime(e.value.toFixed(2))}}),c.prototype=t.extend(n.prototype,{title:"Summary of content types.",data:[{value:0,label:i.pieLabelHTMLText,color:L.ContentPie.HTMLText},{value:0,label:i.pieLabelJavaScript,color:L.ContentPie.JavaScript},{value:0,label:i.pieLabelCSS,color:L.ContentPie.CSS},{value:0,label:i.pieLabelImage,color:L.ContentPie.Image},{value:0,label:i.pieLabelFlash,color:L.ContentPie.Flash},{value:0,label:i.pieLabelOthers,color:L.ContentPie.Others}],getLabelTooltipText:function(e){return e.count+"x "+e.label+": "+t.formatSize(e.value)}}),d.prototype=t.extend(n.prototype,{title:"Summary of sent and received bodies & headers.",data:[{value:0,label:i.pieLabelHeadersSent,color:L.TrafficPie.HeadersSent},{value:0,label:i.pieLabelBodiesSent,color:L.TrafficPie.BodiesSent},{value:0,label:i.pieLabelHeadersReceived,color:L.TrafficPie.HeadersReceived},{value:0,label:i.pieLabelBodiesReceived,color:L.TrafficPie.BodiesReceived}]}),u.prototype=t.extend(n.prototype,{title:"Comparison of downloaded data from the server and browser cache.",data:[{value:0,label:i.pieLabelDownloaded,color:L.CachePie.Downloaded},{value:0,label:i.pieLabelPartial,color:L.CachePie.Partial},{value:0,label:i.pieLabelFromCache,color:L.CachePie.FromCache}],getLabelTooltipText:function(e){return e.count+"x "+e.label+": "+t.formatSize(e.value)}});var C=new s,w=new c,B=new d,x=new u;return h.prototype=p({element:null,tag:v({class:"pageStatsBody",style:"height: auto; display: none"}),update:function(e){if(this.isVisible()){this.cleanUp(),e.length||e.push(null);var i=new a(this.model),l=i.calcTimingsTotalsForPages(e);C.data[0].value=l.blocked,C.data[1].value=l.dns,C.data[2].value=l.ssl,C.data[3].value=l.connect,C.data[4].value=l.send,C.data[5].value=l.wait,C.data[6].value=l.receive;var o=i.calcContentTotalsForPages(e);w.data[0].value=o.html.resBodySize,w.data[0].count=o.html.count,w.data[1].value=o.js.resBodySize,w.data[1].count=o.js.count,w.data[2].value=o.css.resBodySize,w.data[2].count=o.css.count,w.data[3].value=o.image.resBodySize,w.data[3].count=o.image.count,w.data[4].value=o.flash.resBodySize,w.data[4].count=o.flash.count,w.data[5].value=o.other.resBodySize,w.data[5].count=o.other.count;var n=i.calcTrafficTotalsForPages(e);B.data[0].value=n.request.headersSize,B.data[1].value=n.request.bodySize,B.data[2].value=n.response.headersSize,B.data[3].value=n.response.bodySize;var r=i.calcCacheTotalsForPages(e);x.data[1].value=r.partial.resBodySize,x.data[1].count=r.partial.count,x.data[2].value=r.cached.resBodySize,x.data[2].count=r.cached.count,x.data[0].value=r.downloaded.resBodySize,x.data[0].count=r.downloaded.count,y.draw(t.$(this.timingPie,"pieGraph"),C),y.draw(t.$(this.contentPie,"pieGraph"),w),y.draw(t.$(this.trafficPie,"pieGraph"),B),y.draw(t.$(this.cachePie,"pieGraph"),x)}},cleanUp:function(){C.cleanUp(),w.cleanUp(),B.cleanUp(),x.cleanUp()},showInfoTip:function(e,t,a,i){return y.showInfoTip(e,t,a,i)},onSelectionChange:function(e){this.update(e)},show:function(e){if(!this.isVisible()){o.addListener(this),t.setClass(this.element,"opened"),e?$(this.element).slideDown():this.element.style.display="block";var a=this.timeline.getSelection();this.update(a)}},hide:function(e){this.isVisible()&&(o.removeListener(this),t.removeClass(this.element,"opened"),e?$(this.element).slideUp():this.element.style.display="none")},isVisible:function(){return t.hasClass(this.element,"opened")},toggle:function(e){this.isVisible()?this.hide(e):this.show(e)},render:function(e){return this.element=this.tag.replace({},e),this.timingPie=y.render(C,this.element),this.contentPie=y.render(w,this.element),this.trafficPie=y.render(B,this.element),this.cachePie=y.render(x,this.element),this.cachePie.style.borderRight=0,this.element}}),h});