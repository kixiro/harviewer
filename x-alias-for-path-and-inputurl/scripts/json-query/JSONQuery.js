/*
Copyright Jason E. Smith 2008 Licensed under the Apache License, Version 2.0 (the "License");
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
*/

!function(){function map(r,e){var t=r.length;if("function"!=typeof e)throw new TypeError;for(var n=new Array(t),a=arguments[2],u=0;t>u;u++)u in r&&(n[u]=e.call(a,r[u],u,r));return n}function filter(r,e){var t=r.length;if("function"!=typeof e)throw new TypeError;for(var n=new Array,a=arguments[2],u=0;t>u;u++)if(u in r){var c=r[u];e.call(a,c,u,r)&&n.push(c)}return n}function slice(r,e,t,n){var a=r.length,u=[];t=t||a,e=0>e?Math.max(0,e+a):Math.min(a,e),t=0>t?Math.max(0,t+a):Math.min(a,t);for(var c=e;t>c;c+=n)u.push(r[c]);return u}function expand(r,e){function t(r){e&&(e!==!0||r instanceof Array?r[e]&&n.push(r[e]):n.push(r));for(var a in r){var u=r[a];e?u&&"object"==typeof u&&t(u):n.push(u)}}var n=[];if(e instanceof Array){if(1==e.length)return r[e[0]];for(var a=0;a<e.length;a++)n.push(r[e[a]])}else t(r);return n}function distinctFilter(r,e){for(var t=[],n={},a=0,u=r.length;u>a;++a){var c=r[a];e(c,a,r)&&("object"==typeof c&&c?c.__included||(c.__included=!0,t.push(c)):n[c+typeof c]||(n[c+typeof c]=!0,t.push(c)))}for(a=0,u=t.length;u>a;++a)t[a]&&delete t[a].__included;return t}var JSONQuery=function(query,obj){function call(r){prefix=r+"("+prefix}function makeRegex(r,e,t,n,a){return str[a].match(/[\*\?]/)||"~"==n?"/^"+str[a].substring(1,str[a].length-1).replace(/\\([btnfr\\"'])|([^\w\*\?])/g,"\\$1$2").replace(/([\*\?])/g,".$1")+("~"==n?"$/i":"$/")+".test("+e+")":r}tokens=[];var depth=0,str=[];query=query.replace(/"(\\.|[^"\\])*"|'(\\.|[^'\\])*'|[\[\]]/g,function(r){return depth+="["==r?1:"]"==r?-1:0,"]"==r&&depth>0?"`]":'"'==r.charAt(0)||"'"==r.charAt(0)?"`"+(str.push(r)-1):r});var prefix="";query.replace(/(\]|\)|push|pop|shift|splice|sort|reverse)\s*\(/,function(){throw new Error("Unsafe function call")}),query=query.replace(/([^=]=)([^=])/g,"$1=$2").replace(/@|(\.\s*)?[a-zA-Z\$_]+(\s*:)?/g,function(r){return"."==r.charAt(0)?r:"@"==r?"$obj":(r.match(/:|^(\$|Math|true|false|null)$/)?"":"$obj.")+r}).replace(/\.?\.?\[(`\]|[^\]])*\]|\?.*|\.\.([\w\$_]+)|\.\*/g,function(r,e,t){var n=r.match(/^\.?\.?(\[\s*\^?\?|\^?\?|\[\s*==)(.*?)\]?$/);if(n){var a="";return r.match(/^\./)&&(call("expand"),a=",true)"),call(n[1].match(/\=/)?"map":n[1].match(/\^/)?"distinctFilter":"filter"),a+",function($obj){return "+n[2]+"})"}return(n=r.match(/^\[\s*([\/\\].*)\]/))?".concat().sort(function(a,b){"+n[1].replace(/\s*,?\s*([\/\\])\s*([^,\\\/]+)/g,function(r,e,t){return"var av= "+t.replace(/\$obj/,"a")+",bv= "+t.replace(/\$obj/,"b")+";if(av>bv||bv==null){return "+("/"==e?1:-1)+";}\nif(bv>av||av==null){return "+("/"==e?-1:1)+";}\n"})+"})":(n=r.match(/^\[(-?[0-9]*):(-?[0-9]*):?(-?[0-9]*)\]/),n?(call("slice"),","+(n[1]||0)+","+(n[2]||0)+","+(n[3]||1)+")"):r.match(/^\.\.|\.\*|\[\s*\*\s*\]|,/)?(call("expand"),("."==r.charAt(1)?",'"+t+"'":r.match(/,/)?","+r:"")+")"):r)}).replace(/(\$obj\s*(\.\s*[\w_$]+\s*)*)(==|~)\s*`([0-9]+)/g,makeRegex).replace(/`([0-9]+)\s*(==|~)\s*(\$obj(\s*\.\s*[\w_$]+)*)/g,function(r,e,t,n,a){return makeRegex(r,n,a,t,e)}),query=prefix+("$"==query.charAt(0)?"":"$")+query.replace(/`([0-9]+|\])/g,function(r,e){return"]"==e?"]":str[e]});for(var executor=eval("1&&function($,$1,$2,$3,$4,$5,$6,$7,$8,$9){var $obj=$;return "+query+"}"),i=0;i<arguments.length-1;i++)arguments[i]=arguments[i+1];return obj?executor.apply(this,arguments):executor};"function"==typeof namespace?namespace("json::JSONQuery",JSONQuery):window.JSONQuery=JSONQuery}();