/* See license.txt for terms of usage */

define("preview/requestBody",["domplate/domplate","i18n!nls/requestBody","core/lib","core/cookies","domplate/tabView","domplate/domTree","core/dragdrop","syntax-highlighter/shCore"],function(e,t,n,a,o,i,s,r){function l(){}function p(e){this.file=e}function c(e){this.file=e}function d(e){this.file=e}function f(e){this.file=e}function h(e){this.file=e}function u(e){this.file=e}function m(e,n){n=n.charAt(0).toUpperCase()+n.slice(1).toLowerCase(),this.file=e,this.id=n,this.label=t[n]}function T(e){this.file=e}function g(e){this.file=e}function y(e){this.file=e}function x(e){this.file=e}function v(e){this.file=e}function b(e){this.file=e}var w=e.domplate,I=e.DIV,C=e.FOR,H=e.IFRAME,R=e.PRE,B=e.TABLE,D=e.TBODY,q=e.TD,S=e.TR;return l.prototype=w({render:function(e,t){var n=new o("requestBody");t.response.headers.length>0&&n.appendTab(new p(t)),t.request.queryString&&t.request.queryString.length&&n.appendTab(new u(t)),l.isValidPostData(t)&&n.appendTab(new m(t,t.request.method)),f.canShowFile(t)&&n.appendTab(new f(t)),h.canShowFile(t)&&n.appendTab(new h(t)),v.canShowFile(t)&&n.appendTab(new v(t)),b.canShowFile(t)&&n.appendTab(new b(t)),c.canShowFile(t)&&n.appendTab(new c(t)),d.canShowFile(t)&&n.appendTab(new d(t)),this.showCache(t)&&n.appendTab(new g(t)),this.showHtml(t)&&n.appendTab(new y(t)),this.showDataURL(t)&&n.appendTab(new x(t));var a=n.render(e);return n.tabs.length>0&&n.selectTabByName(n.tabs[0].id),a},showCache:function(e){return e.cache&&e.cache.afterRequest?!0:!1},showHtml:function(e){var t=e.response.content.mimeType||"",a=e.mimeType||"";return n.startsWith(t,"text/html")||n.startsWith(a,"application/xhtml+xml")},showDataURL:function(e){return 0===e.request.url.indexOf("data:")}}),l.isValidPostData=function(e){var t=e.request.postData;if(!t)return!1;var a=!n.isArray(t.params)||0===t.params.length,o=!t.text,i=a&&o;return i?["PUT","POST"].indexOf(e.request.method)>-1:!0},l.canDecode=function(e){return e?"base64"!==e?!1:"undefined"==typeof atob?!1:!0:!0},l.decode=function(e,t){return"base64"===t?atob(e):e},p.prototype=w(o.Tab.prototype,{id:"Headers",label:t.Headers,bodyTag:B({"class":"netInfoHeadersText netInfoText netInfoHeadersTable",cellpadding:0,cellspacing:0},D(S({"class":"netInfoResponseHeadersTitle"},q({colspan:2},I({"class":"netInfoHeadersGroup"},t.ResponseHeaders))),S({"class":"netInfoRequestHeadersTitle"},q({colspan:2},I({"class":"netInfoHeadersGroup"},t.RequestHeaders))))),headerDataTag:C("param","$headers",S(q({"class":"netInfoParamName"},"$param.name"),q({"class":"netInfoParamValue"},R("$param|getParamValue")))),getParamValue:function(e){return n.wrapText(e.value,!0)},onUpdateBody:function(e,t){this.file.response.headers&&this.insertHeaderRows(t,this.file.response.headers,"Headers","ResponseHeaders"),this.file.request.headers&&this.insertHeaderRows(t,this.file.request.headers,"Headers","RequestHeaders")},insertHeaderRows:function(e,t,a,o){var i=n.getElementByClass(e,"netInfo"+a+"Table"),s=n.getElementByClass(i,"netInfo"+o+"Title");t.length?(this.headerDataTag.insertRows({headers:t},s?s:e),n.removeClass(s,"collapsed")):n.setClass(s,"collapsed")}}),c.prototype=w(o.Tab.prototype,{id:"Image",label:t.Image,title:t.ImageTitle,bodyTag:I({"class":"netInfoImageText netInfoText"}),onUpdateBody:function(e,t){function a(e){var t=n.extractMimeType(e.mimeType);return"data:"+t+";base64,"+e.text}function o(e,n){var o=t.ownerDocument.createElement("img"),i=e.response.content;o.src=a(i),n.appendChild(o)}function i(e,t){var n=e.response.content,o=/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/;if(n.text.match(o)){var i=a(n);t.innerHTML="<img src="+i+">"}}var s=n.getElementByClass(t,"netInfoImageText");n.clearNode(s);var r=9===document.documentMode||10===document.documentMode;r?i(this.file,s):o(this.file,s)}}),c.isFileImage=function(e){var t=e.response.content;if(!t)return!1;var a=n.extractMimeType(t.mimeType||"");return n.startsWith(a,"image/")},c.canShowFile=function(e){var t=e.response.content;return c.isFileImage(e)&&t.text&&"base64"===t.encoding},d.prototype=w(o.Tab.prototype,{id:"ExternalImage",label:t.ExternalImage,title:t.ExternalImageTitle,bodyTag:I({"class":"netInfoExternalImageText netInfoText"}),onUpdateBody:function(e,t){var a=n.getElementByClass(t,"netInfoExternalImageText");n.clearNode(a);var o=t.ownerDocument.createElement("img");o.src=this.file.request.url,a.appendChild(o)}}),d.canShowFile=function(e){return c.isFileImage(e)},f.prototype=w(o.Tab.prototype,{id:"Response",label:t.Response,bodyTag:I({"class":"netInfoResponseText netInfoText"},R()),onUpdateBody:function(e,t){var a=n.getElementByClass(t,"netInfoResponseText"),o=a.firstChild;n.clearNode(o);var i=this.file.response.content.text;n.insertWrappedText(i,o)}}),f.canShowFile=function(e){return e.response.content.text&&e.response.content.text.length>0},h.prototype=w(o.Tab.prototype,{id:"Highlighted",label:t.Highlighted,bodyTag:I({"class":"netInfoHighlightedText netInfoText"},R({"class":"toolbar: false; brush: ",name:"code"})),onUpdateBody:function(e,t){var a=n.getElementByClass(t,"netInfoHighlightedText"),o=a.firstChild;n.clearNode(o);var i=this.file.response.content,s=i.text,p=n.extractMimeType(i.mimeType),c=h.shouldHighlightAs(p);c?(o.className+=c,s=l.decode(s,i.encoding),o.appendChild(document.createTextNode(s)),r.SyntaxHighlighter.highlight(o)):n.insertWrappedText(s,o)}}),h.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!l.canDecode(t.encoding))return!1;var a=n.extractMimeType(t.mimeType||"");return null!==h.shouldHighlightAs(a)},h.shouldHighlightAs=function(e){var t={javascript:["application/javascript","text/javascript","application/x-javascript","text/ecmascript","application/ecmascript","application/json"],css:["text/css"],html:["text/html","application/xhtml+xml"]};for(var n in t)if(t[n].indexOf(e)>-1)return n;return b.isXmlMimeType(e)?"xml":null},u.prototype=w(p.prototype,{id:"Params",label:t.URLParameters,bodyTag:B({"class":"netInfoParamsText netInfoText netInfoParamsTable",cellpadding:0,cellspacing:0},D()),onUpdateBody:function(e,t){if(this.file.request.queryString){var a=n.getElementByClass(t,"netInfoParamsText");this.insertHeaderRows(a,this.file.request.queryString,"Params")}}}),m.prototype=w(p.prototype,{bodyTag:I({"class":"netInfo$tab.id\\Text netInfoText"},B({"class":"netInfo$tab.id\\Table",cellpadding:0,cellspacing:0},D())),onUpdateBody:function(e,t){var a=this.file.request.postData;if(a){var o=n.getElementByClass(t,"netInfo"+this.id+"Text");"application/x-www-form-urlencoded"===a.mimeType?this.insertHeaderRows(o,a.params,this.id):n.insertWrappedText(a.text,o)}}}),T.prototype=w(p.prototype,{id:"Cookies",label:t.Cookies,bodyTag:I({"class":"netInfoCookiesText netInfoText"},B({"class":"netInfoCookiesTable",cellpadding:0,cellspacing:0},D(S({"class":"netInfoResponseCookiesTitle"},q({colspan:2},I({"class":"netInfoCookiesGroup"},t.ResponseCookies))),S({"class":"netInfoRequestCookiesTitle"},q({colspan:2},I({"class":"netInfoCookiesGroup"},t.RequestCookies)))))),onUpdateBody:function(e,t){var a=n.getElementByClass(t,"netInfoParamsText");this.file.response.cookies&&this.insertHeaderRows(a,this.file.response.cookies,"Cookies","ResponseCookies"),this.file.request.cookies&&this.insertHeaderRows(a,this.file.request.cookies,"Cookies","RequestCookies")}}),g.prototype=w(p.prototype,{id:"Cache",label:t.Cache,bodyTag:I({"class":"netInfoCacheText netInfoText"},B({"class":"netInfoCacheTable",cellpadding:0,cellspacing:0},D())),onUpdateBody:function(e,t){if(this.file.cache&&this.file.cache.afterRequest){var n=this.file.cache.afterRequest,a=[];for(var o in n)a.push({name:o,value:n[o]});this.insertHeaderRows(t,a,"Cache")}}}),y.prototype=w(p.prototype,{id:"HTML",label:t.HTML,bodyTag:I({"class":"netInfoHtmlText netInfoText"},H({"class":"netInfoHtmlPreview",onload:"$onLoad"}),I({"class":"htmlPreviewResizer"})),onUpdateBody:function(e,t){this.preview=n.getElementByClass(t,"netInfoHtmlPreview");var o=parseInt(a.getCookie("htmlPreviewHeight"),10);isNaN(o)||(this.preview.style.height=o+"px");var i=n.getElementByClass(t,"htmlPreviewResizer");this.resizer=new s.Tracker(i,{onDragStart:n.bind(this.onDragStart,this),onDragOver:n.bind(this.onDragOver,this),onDrop:n.bind(this.onDrop,this)})},onLoad:function(e){var t=n.fixEvent(e),a=n.getAncestorByClass(t.target,"tabHTMLBody").repObject;a.preview.contentWindow.document.body.innerHTML=a.file.response.content.text},onDragStart:function(e){var t=n.getBody(this.preview.ownerDocument);t.setAttribute("hResizing","true"),this.startHeight=this.preview.clientHeight},onDragOver:function(e,t){var n=this.startHeight+e.y;this.preview.style.height=n+"px",a.setCookie("htmlPreviewHeight",n)},onDrop:function(e){var t=n.getBody(this.preview.ownerDocument);t.removeAttribute("hResizing")}}),x.prototype=w(p.prototype,{id:"DataURL",label:t.DataURL,bodyTag:I({"class":"netInfoDataURLText netInfoText"}),onUpdateBody:function(e,t){var a=n.getElementByClass(t,"netInfoDataURLText"),o=this.file.request.url;if(0===o.indexOf("data:image")){var i=t.ownerDocument.createElement("img");i.src=o,a.appendChild(i)}else n.insertWrappedText(unescape(o),a)}}),v.prototype=w(o.Tab.prototype,{id:"JSON",label:t.JSON,bodyTag:I({"class":"netInfoJsonText netInfoText"}),onUpdateBody:function(e,t){n.clearNode(t.firstChild);var a=this.file.response.content;try{var o=l.decode(a.text,a.encoding),s=JSON.parse(o),r=new i(s);r.append(t)}catch(p){t.innerHTML=String(p)}}}),v.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!l.canDecode(t.encoding))return!1;var a=n.extractMimeType(t.mimeType||"");return["application/json"].indexOf(a)>-1},b.prototype=w(o.Tab.prototype,{id:"XML",label:t.XML,bodyTag:I({"class":"netInfoXmlText netInfoText"}),onUpdateBody:function(e,t){n.clearNode(t.firstChild);var a=this.file.response.content;try{var o=l.decode(a.text,a.encoding),s=$.parseXML(o),r=new i(s);r.append(t)}catch(p){t.innerHTML=String(p)}}}),b.isXmlMimeType=function(e){return e=n.extractMimeType(e),["text/xml","application/xml","image/svg+xml","application/atom+xml","application/xslt+xml","application/mathml+xml","application/rss+xml"].indexOf(e)>-1},b.canShowFile=function(e){var t=e.response.content;if(!t||!t.text)return!1;if(!l.canDecode(t.encoding))return!1;var a=n.extractMimeType(t.mimeType||"");return b.isXmlMimeType(a)},l});